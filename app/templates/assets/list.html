{% extends "base.html" %}
{% block content %}

<!-- QR MODAL (Keep existing) -->
<div id="qrViewModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center" onclick="closeModal('qrViewModal')">
    <div class="bg-white p-5 rounded-xl max-w-sm w-full text-center relative" onclick="event.stopPropagation()">
        <h3 class="font-bold text-lg mb-2">Asset QR Code</h3>
        <div id="qrImageContainer" class="flex justify-center mb-4"></div>
        <p class="text-xs text-gray-500 mb-4">Hash: <span id="qrHashDisplay" class="font-mono"></span></p>
        <button onclick="closeModal('qrViewModal')" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300 w-full">Close</button>
    </div>
</div>

<div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
    <div>
        <h2 class="text-3xl font-bold text-gray-800 tracking-tight">Asset Inventory</h2>
        <p class="text-gray-500 text-sm mt-1">Manage laptops, stock, and allocations.</p>
    </div>
    <div class="flex space-x-3">
        <button onclick="openModal('addAssetModal')" class="bg-brand hover:bg-brand-dark text-white px-5 py-2.5 rounded-lg shadow-md transition-all flex items-center transform hover:scale-105">
            <i class="fas fa-plus mr-2"></i> Add Asset
        </button>
        <div class="relative group">
            <button class="bg-gray-800 text-white px-5 py-2.5 rounded-lg shadow-md hover:bg-gray-900 transition-all flex items-center">
                <i class="fas fa-file-download mr-2"></i> Export
            </button>
            <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl hidden group-hover:block border border-gray-100 z-20">
                <button onclick="exportData('summary')" class="w-full text-left block px-4 py-2 text-gray-700 hover:bg-brand hover:text-white rounded-t-lg text-sm">Current Summary</button>
                <button onclick="exportData('detailed')" class="w-full text-left block px-4 py-2 text-gray-700 hover:bg-brand hover:text-white rounded-b-lg text-sm">Full History Log</button>
            </div>
        </div>
    </div>
</div>

<!-- SEARCH BAR -->
<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 mb-6 transition-shadow hover:shadow-md">
    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
        <div class="md:col-span-5 relative">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            <input type="text" id="searchInput" placeholder="Search Serial, Model, Person or Branch..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-brand focus:border-brand transition-all">
        </div>
        <div class="md:col-span-3">
            <select id="statusFilter" class="w-full border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-brand focus:border-brand bg-white">
                <option value="">All Status</option>
                <option value="In Stock">In Stock</option>
                <option value="Allocated">Allocated</option>
                <option value="Repair">Repair</option>
                <option value="In Transit">In Transit</option>
            </select>
        </div>
        <div class="md:col-span-4">
            <select id="branchFilter" class="w-full border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-brand focus:border-brand bg-white">
                <option value="">All Branches</option>
                {% for b in branches %}
                <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<!-- ASSET TABLE -->
<div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
    <table class="min-w-full leading-normal">
        <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
                <th class="px-5 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">#</th>
                <th class="px-5 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:text-brand transition-colors" onclick="sortBy('serial')">
                    Serial <i class="fas fa-sort ml-1"></i>
                </th>
                <th class="px-5 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:text-brand transition-colors" onclick="sortBy('model')">
                    Details <i class="fas fa-sort ml-1"></i>
                </th>
                <th class="px-5 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:text-brand transition-colors" onclick="sortBy('status')">
                    Status <i class="fas fa-sort ml-1"></i>
                </th>
                <th class="px-5 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:text-brand transition-colors" onclick="sortBy('branch')">
                    Current Branch <i class="fas fa-sort ml-1"></i>
                </th>
                <th class="px-5 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:text-brand transition-colors" onclick="sortBy('holder')">
                    Holder <i class="fas fa-sort ml-1"></i>
                </th>
                <th class="px-5 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Action</th>
            </tr>
        </thead>
        <tbody id="assetsTableBody">
            {% include 'assets/_table_rows.html' %}
        </tbody>
    </table>
</div>

<!-- ADD ASSET MODAL -->
<div id="addAssetModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-40 flex items-center justify-center backdrop-blur-sm">
    <div class="relative p-6 border w-96 shadow-2xl rounded-xl bg-white">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-xl font-bold text-gray-800">Add New Asset</h3>
            <button type="button" onclick="closeModal('addAssetModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <form action="{{ url_for('assets.add') }}" method="POST" enctype="multipart/form-data">
            <div class="mb-3"><label class="block text-xs font-bold text-gray-600 mb-1">Serial Number</label><input class="w-full border p-2 rounded focus:ring-brand focus:border-brand" type="text" name="serial" required></div>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div><label class="block text-xs font-bold text-gray-600 mb-1">Brand</label><input class="w-full border p-2 rounded focus:ring-brand focus:border-brand" type="text" name="brand" value="HP" required></div>
                <div><label class="block text-xs font-bold text-gray-600 mb-1">Model</label><input class="w-full border p-2 rounded focus:ring-brand focus:border-brand" type="text" name="model" value="EliteBook" required></div>
            </div>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-600 mb-1">Initial Branch</label>
                <div class="flex gap-2">
                    <select id="assetBranchSelect" class="w-full border p-2 rounded focus:ring-brand focus:border-brand" name="branch_id" required>
                        <option value="" disabled>Select Branch</option>
                        {% for b in branches %}
                        <option value="{{ b.id }}" {% if 'gurugram' in b.name.lower() %}selected{% endif %}>{{ b.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="openModal('addBranchModal')" class="bg-brand text-white px-3 rounded hover:bg-brand-dark shadow-sm" title="Add New Branch">+</button>
                </div>
            </div>
            <div class="mb-6"><label class="block text-xs font-bold text-gray-600 mb-1">Invoice / Doc</label><input type="file" name="document" class="w-full text-xs border p-2 rounded"></div>
            <div class="flex justify-end space-x-2 border-t pt-4">
                <button type="button" onclick="closeModal('addAssetModal')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-brand text-white rounded hover:bg-brand-dark font-medium shadow-lg shadow-orange-200">Save Asset</button>
            </div>
        </form>
    </div>
</div>

<!-- INLINE ADD BRANCH MODAL -->
<div id="addBranchModal" class="hidden fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
    <div class="relative p-6 border w-80 shadow-2xl rounded-xl bg-white">
        <h3 class="text-lg font-bold mb-4 text-brand border-b pb-2">Add Branch</h3>
        <form id="quickAddBranchForm">
            <input class="w-full border p-2 mb-3 rounded focus:ring-brand" type="text" name="name" placeholder="Branch Name" required>
            <input class="w-full border p-2 mb-4 rounded focus:ring-brand" type="text" name="location" placeholder="Location" required>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeModal('addBranchModal')" class="px-3 py-2 bg-gray-200 rounded text-sm text-gray-700">Close</button>
                <button type="submit" class="px-3 py-2 bg-brand text-white rounded text-sm shadow-md">Add</button>
            </div>
        </form>
    </div>
</div>

<!-- QUICK ALLOCATE MODAL (Updated UI & Add Button) -->
<div id="quickAllocateModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="relative p-6 border w-96 shadow-2xl rounded-xl bg-white">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-lg font-bold text-green-700">Quick Allocation</h3>
            <span id="qa_serial" class="font-mono font-bold text-gray-600 bg-gray-100 px-2 rounded"></span>
        </div>
        
        <form action="{{ url_for('assets.allocate') }}" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="asset_id" id="qa_asset_id">
            
            <label class="block text-xs font-bold text-gray-600 mb-1">Select Employee</label>
            <div class="flex gap-2 mb-4">
                <select name="employee_id" id="qa_emp_select" class="w-full border p-2 rounded text-sm bg-white focus:ring-2 focus:ring-green-500" required>
                    <option value="" disabled selected>Loading employees...</option>
                </select>
                <!-- ADD EMPLOYEE BUTTON -->
                <button type="button" onclick="openModal('addEmployeeModal')" class="bg-green-600 text-white px-3 rounded hover:bg-green-700 shadow-sm" title="Add New Employee">+</button>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-600 mb-1">Proof (Optional)</label>
                <input type="file" name="document" class="w-full text-xs border p-2 rounded">
            </div>
            
            <div class="flex justify-end space-x-2 pt-2 border-t">
                <button type="button" onclick="closeModal('quickAllocateModal')" class="px-3 py-2 bg-gray-100 rounded text-sm hover:bg-gray-200">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded text-sm font-bold shadow hover:bg-green-700">Allocate</button>
            </div>
        </form>
    </div>
</div>

<!-- ADD EMPLOYEE MODAL (Required for Quick Allocate) -->
<div id="addEmployeeModal" class="hidden fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full z-[60] flex items-center justify-center">
    <div class="relative p-6 border w-96 shadow-2xl rounded-xl bg-white">
        <h3 class="text-lg font-bold mb-4 text-brand border-b pb-2">Add New Employee</h3>
        <form id="quickAddEmployeeForm">
            <input class="w-full border p-2 mb-3 rounded focus:ring-brand" type="text" name="name" placeholder="Full Name" required>
            <input class="w-full border p-2 mb-3 rounded focus:ring-brand" type="text" name="emp_id" placeholder="Employee ID" required>
            <select class="w-full border p-2 mb-4 rounded bg-white" name="branch_id" required>
                <option value="" disabled selected>Select Home Branch</option>
                {% for b in branches %}
                <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
            </select>
            <div class="flex justify-end space-x-2 pt-2">
                <button type="button" onclick="closeModal('addEmployeeModal')" class="px-3 py-2 bg-gray-200 rounded text-sm text-gray-700 hover:bg-gray-300">Close</button>
                <button type="submit" class="px-3 py-2 bg-brand text-white rounded text-sm shadow-md hover:bg-brand-dark">Add & Select</button>
            </div>
        </form>
    </div>
</div>

<!-- QUICK TRANSFER MODAL -->
<div id="quickTransferModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="relative p-6 border w-96 shadow-2xl rounded-xl bg-white">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-lg font-bold text-blue-700">Change Branch</h3>
            <span id="qt_serial" class="font-mono font-bold text-gray-600 bg-gray-100 px-2 rounded"></span>
        </div>
        <form action="{{ url_for('assets.transfer') }}" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="asset_id" id="qt_asset_id">
            <label class="block text-xs font-bold text-gray-600 mb-1">Destination Branch</label>
            <select name="branch_id" class="w-full border p-2 rounded text-sm mb-3 bg-white focus:ring-2 focus:ring-blue-500" required>
                <option value="" disabled selected>Choose Branch...</option>
                {% for b in branches %}
                <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
            </select>
            <input type="text" name="remarks" placeholder="Remarks (Optional)" class="border p-2 rounded w-full text-sm mb-3">
            <div class="mb-4"><label class="block text-xs font-bold text-gray-600 mb-1">Courier/Doc</label><input type="file" name="document" class="w-full text-xs border p-2 rounded"></div>
            <div class="flex justify-end space-x-2 pt-2 border-t">
                <button type="button" onclick="closeModal('quickTransferModal')" class="px-3 py-2 bg-gray-100 rounded text-sm hover:bg-gray-200">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold shadow hover:bg-blue-700">Move</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    // --- MODAL UTILS ---
    function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    // --- QR Logic ---
    function showQR(hash) {
        const container = document.getElementById('qrImageContainer');
        const display = document.getElementById('qrHashDisplay');
        container.innerHTML = ""; 
        const url = window.location.origin + "/qr/scan/" + hash;
        new QRCode(container, { text: url, width: 200, height: 200 });
        display.innerText = hash.substring(0, 8) + "...";
        openModal('qrViewModal');
    }

    // --- Dynamic Allocation (AJAX Fetch) ---
    function openAllocateModal(id, serial, branchId) {
        document.getElementById('qa_asset_id').value = id;
        document.getElementById('qa_serial').innerText = serial;
        
        const select = document.getElementById('qa_emp_select');
        select.innerHTML = '<option disabled selected>Loading...</option>';
        
        if (!branchId) {
             select.innerHTML = '<option disabled selected>Error: No Branch</option>';
             openModal('quickAllocateModal');
             return;
        }

        fetch(`/assets/get_employees/${branchId}`)
            .then(res => res.json())
            .then(data => {
                select.innerHTML = '<option value="" disabled selected>Select Employee</option>';
                if (data.length === 0) {
                    select.innerHTML += '<option disabled>No active employees in this branch</option>';
                } else {
                    data.forEach(emp => {
                        select.add(new Option(emp.name, emp.id));
                    });
                }
            })
            .catch(err => {
                console.error(err);
                select.innerHTML = '<option disabled>Error loading data</option>';
            });

        openModal('quickAllocateModal');
    }

    function openTransferModal(id, serial) {
        document.getElementById('qt_asset_id').value = id;
        document.getElementById('qt_serial').innerText = serial;
        openModal('quickTransferModal');
    }

    // --- Search/Filter/Sort ---
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const branchFilter = document.getElementById('branchFilter');
    const tableBody = document.getElementById('assetsTableBody');
    let currentSort = 'id';
    let currentOrder = 'desc';

    function sortBy(col) {
        if (currentSort === col) {
            currentOrder = currentOrder === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort = col;
            currentOrder = 'asc';
        }
        fetchResults();
    }

    function fetchResults() {
        const params = new URLSearchParams({
            search: searchInput.value,
            status: statusFilter.value,
            branch_id: branchFilter.value,
            sort: currentSort,
            order: currentOrder
        });
        fetch(`{{ url_for('assets.list_assets') }}?${params.toString()}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => { tableBody.innerHTML = html; });
    }

    // Export Logic
    function exportData(mode) {
        const params = new URLSearchParams({
            mode: mode,
            search: searchInput.value,
            status: statusFilter.value,
            branch_id: branchFilter.value
        });
        window.location.href = `{{ url_for('assets.export_csv') }}?${params.toString()}`;
    }

    let timeout = null;
    searchInput.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(fetchResults, 300);
    });
    statusFilter.addEventListener('change', fetchResults);
    branchFilter.addEventListener('change', fetchResults);

    // --- Quick Add Branch ---
    document.getElementById('quickAddBranchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch("{{ url_for('assets.add_branch') }}", {
            method: 'POST', body: formData, headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                const select = document.getElementById('assetBranchSelect');
                select.add(new Option(data.name, data.id));
                select.value = data.id;
                closeModal('addBranchModal');
                this.reset();
            } else { alert(data.message); }
        });
    });

    // --- Quick Add Employee (New for Modal) ---
    document.getElementById('quickAddEmployeeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch("{{ url_for('employees.add_employee') }}", {
            method: 'POST', body: formData, headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                const select = document.getElementById('qa_emp_select');
                const option = new Option(data.name, data.id);
                select.add(option);
                select.value = data.id;
                closeModal('addEmployeeModal');
                this.reset();
            } else { alert(data.message); }
        });
    });
</script>
{% endblock %}