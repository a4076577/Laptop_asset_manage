<!-- Path: app/templates/assets/list.html -->
{% extends "base.html" %}
{% block content %}

<div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
    <div>
        <h2 class="text-3xl font-bold text-gray-800">Asset Inventory</h2>
        <p class="text-gray-500 text-sm mt-1">Manage laptops, stock, and allocations.</p>
    </div>
    <div class="flex space-x-3">
        <button onclick="document.getElementById('addAssetModal').classList.remove('hidden')" class="bg-brand hover:bg-brand-dark text-white px-5 py-2.5 rounded-lg shadow-md transition-all flex items-center">
            <i class="fas fa-plus mr-2"></i> Add Asset
        </button>
        
        <!-- Export Dropdown -->
        <div class="relative group">
            <button class="bg-gray-800 text-white px-5 py-2.5 rounded-lg shadow-md hover:bg-gray-900 transition-all flex items-center">
                <i class="fas fa-file-download mr-2"></i> Export
            </button>
            <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl hidden group-hover:block border border-gray-100 z-20">
                <a href="{{ url_for('assets.export_csv', mode='summary') }}" class="block px-4 py-2 text-gray-700 hover:bg-brand hover:text-white rounded-t-lg text-sm">
                    Current Summary
                </a>
                <a href="{{ url_for('assets.export_csv', mode='detailed') }}" class="block px-4 py-2 text-gray-700 hover:bg-brand hover:text-white rounded-b-lg text-sm">
                    Full History Log
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Search Bar -->
<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
        <div class="md:col-span-5 relative">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            <input type="text" id="searchInput" placeholder="Search Serial, Model, Person or Branch..." 
                   class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-brand focus:border-brand transition-all">
        </div>
        <div class="md:col-span-3">
            <select id="statusFilter" class="w-full border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-brand focus:border-brand">
                <option value="">All Status</option>
                <option value="In Stock">In Stock</option>
                <option value="Allocated">Allocated</option>
                <option value="Repair">Repair</option>
                <option value="In Transit">In Transit</option>
            </select>
        </div>
        <div class="md:col-span-4">
            <select id="branchFilter" class="w-full border border-gray-200 rounded-lg p-2 focus:ring-2 focus:ring-brand focus:border-brand">
                <option value="">All Branches</option>
                {% for b in branches %}
                <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<!-- Table -->
<div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
    <table class="min-w-full leading-normal">
        <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
                <th class="px-5 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Serial</th>
                <th class="px-5 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Details</th>
                <th class="px-5 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-5 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Current Branch</th>
                <th class="px-5 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Holder</th>
                <th class="px-5 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Action</th>
            </tr>
        </thead>
        <tbody id="assetsTableBody">
            {% include 'assets/_table_rows.html' %}
        </tbody>
    </table>
</div>

<!-- ADD ASSET MODAL -->
<div id="addAssetModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-40 flex items-center justify-center backdrop-blur-sm">
    <div class="relative p-6 border w-96 shadow-2xl rounded-xl bg-white">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-xl font-bold text-gray-800">Add New Asset</h3>
            <button onclick="document.getElementById('addAssetModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <form action="{{ url_for('assets.add') }}" method="POST">
            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-600 mb-1">Serial Number</label>
                <input class="w-full border p-2 rounded focus:ring-brand focus:border-brand" type="text" name="serial" required>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Brand</label>
                    <input class="w-full border p-2 rounded focus:ring-brand focus:border-brand" type="text" name="brand" value="HP" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Model</label>
                    <input class="w-full border p-2 rounded focus:ring-brand focus:border-brand" type="text" name="model" value="EliteBook" required>
                </div>
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-600 mb-1">Initial Branch</label>
                <div class="flex gap-2">
                    <select id="assetBranchSelect" class="w-full border p-2 rounded focus:ring-brand focus:border-brand" name="branch_id" required>
                        <option value="" disabled>Select Branch</option>
                        {% for b in branches %}
                        <option value="{{ b.id }}" {% if 'gurugram' in b.name.lower() %}selected{% endif %}>{{ b.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="document.getElementById('addBranchModal').classList.remove('hidden')" class="bg-brand text-white px-3 rounded hover:bg-brand-dark" title="Add New Branch">+</button>
                </div>
            </div>
            <div class="flex justify-end space-x-2 border-t pt-4">
                <button type="button" onclick="document.getElementById('addAssetModal').classList.add('hidden')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-brand text-white rounded hover:bg-brand-dark font-medium shadow-lg shadow-orange-200">Save Asset</button>
            </div>
        </form>
    </div>
</div>

<!-- INLINE ADD BRANCH MODAL -->
<div id="addBranchModal" class="hidden fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
    <div class="relative p-5 border w-80 shadow-xl rounded-md bg-white">
        <h3 class="text-lg font-bold mb-2 text-brand">Add Branch</h3>
        <form id="quickAddBranchForm">
            <input class="w-full border p-2 mb-2 rounded" type="text" name="name" placeholder="Branch Name" required>
            <input class="w-full border p-2 mb-4 rounded" type="text" name="location" placeholder="Location" required>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="document.getElementById('addBranchModal').classList.add('hidden')" class="px-3 py-1 bg-gray-300 rounded text-sm">Close</button>
                <button type="submit" class="px-3 py-1 bg-brand text-white rounded text-sm">Add</button>
            </div>
        </form>
    </div>
</div>

<!-- SHORTCUT: QUICK ALLOCATE MODAL -->
<div id="quickAllocateModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="relative p-6 border w-80 shadow-2xl rounded-xl bg-white">
        <h3 class="text-lg font-bold mb-2 text-green-700">Quick Allocation</h3>
        <p class="text-xs text-gray-500 mb-4">Assign <span id="qa_serial" class="font-mono font-bold text-black"></span> to user.</p>
        <form action="{{ url_for('assets.allocate') }}" method="POST">
            <input type="hidden" name="asset_id" id="qa_asset_id">
            
            <label class="block text-xs font-bold text-gray-600 mb-1">Select Employee</label>
            <select name="employee_id" class="w-full border p-2 rounded text-sm mb-4 bg-white" required>
                <option value="" disabled selected>Choose...</option>
                {% for emp in employees %}
                <option value="{{ emp.id }}">{{ emp.name }} ({{ emp.emp_id }})</option>
                {% endfor %}
            </select>
            
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="document.getElementById('quickAllocateModal').classList.add('hidden')" class="px-3 py-2 bg-gray-100 rounded text-sm">Cancel</button>
                <button type="submit" class="px-3 py-2 bg-green-600 text-white rounded text-sm shadow">Allocate</button>
            </div>
        </form>
    </div>
</div>

<!-- SHORTCUT: QUICK TRANSFER (CHANGE BRANCH) MODAL -->
<div id="quickTransferModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="relative p-6 border w-80 shadow-2xl rounded-xl bg-white">
        <h3 class="text-lg font-bold mb-2 text-blue-700">Change Branch</h3>
        <p class="text-xs text-gray-500 mb-4">Move <span id="qt_serial" class="font-mono font-bold text-black"></span> to new location.</p>
        <form action="{{ url_for('assets.transfer') }}" method="POST">
            <input type="hidden" name="asset_id" id="qt_asset_id">
            
            <label class="block text-xs font-bold text-gray-600 mb-1">Destination Branch</label>
            <select name="branch_id" class="w-full border p-2 rounded text-sm mb-3 bg-white" required>
                <option value="" disabled selected>Choose Branch...</option>
                {% for b in branches %}
                <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
            </select>
            
            <input type="text" name="remarks" placeholder="Remarks (Optional)" class="border p-2 rounded w-full text-sm mb-4">
            
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="document.getElementById('quickTransferModal').classList.add('hidden')" class="px-3 py-2 bg-gray-100 rounded text-sm">Cancel</button>
                <button type="submit" class="px-3 py-2 bg-blue-600 text-white rounded text-sm shadow">Move</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Real-time Logic (Search & Filtering)
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const branchFilter = document.getElementById('branchFilter');
    const tableBody = document.getElementById('assetsTableBody');

    function fetchResults() {
        const params = new URLSearchParams({
            search: searchInput.value,
            status: statusFilter.value,
            branch_id: branchFilter.value
        });

        fetch(`{{ url_for('assets.list_assets') }}?${params.toString()}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            tableBody.innerHTML = html;
        })
        .catch(err => console.error('Error fetching results:', err));
    }

    let timeout = null;
    searchInput.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(fetchResults, 300);
    });

    statusFilter.addEventListener('change', fetchResults);
    branchFilter.addEventListener('change', fetchResults);

    // Quick Add Branch Logic
    document.getElementById('quickAddBranchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch("{{ url_for('assets.add_branch') }}", {
            method: 'POST', body: formData, headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                const select = document.getElementById('assetBranchSelect');
                const option = new Option(data.name, data.id);
                select.add(option);
                select.value = data.id;
                document.getElementById('addBranchModal').classList.add('hidden');
                this.reset();
            } else { alert(data.message); }
        });
    });

    // Shortcut Modal Openers
    function openAllocateModal(id, serial) {
        document.getElementById('qa_asset_id').value = id;
        document.getElementById('qa_serial').innerText = serial;
        document.getElementById('quickAllocateModal').classList.remove('hidden');
    }

    function openTransferModal(id, serial) {
        document.getElementById('qt_asset_id').value = id;
        document.getElementById('qt_serial').innerText = serial;
        document.getElementById('quickTransferModal').classList.remove('hidden');
    }
</script>

{% endblock %}